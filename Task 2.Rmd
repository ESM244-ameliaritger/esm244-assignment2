---
title: "Task 2"
author: "Amelia Ritger"
date: "2/13/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

## Here's a useful and descriptive introductory summary! 
Curious where the data comes from? [Look no further!](http://www.cbr.washington.edu/dart/query/adult_graph_text)

## Here's an image of a steelhead or the Bonneville Dam!

## Now let's get into the code! 

Load necessary packages and data
```{r}
library(tidyverse)
library(janitor)
library(lubridate)
library(tsibble)
library(feasts)

raw_fish <- read_csv("cbr_fish_passage_bonneville_allyrs_steelhead.csv") %>% 
  clean_names()
```

Tidy the data
```{r}
Sys.setlocale("LC_TIME", "en_US.UTF-8")

fish <- raw_fish %>%
  #drop_na(value) %>% #drop NA values
  #filter(value>=0) %>% #drop negative values because metadata doesn't explain what they mean
  mutate(value = replace_na(value, "0")) %>% 
  #as.Date(mm_dd, format="%d-%b")
  separate(mm_dd, into=c("day", "month")) %>% #separate out month and day
  mutate(day = sprintf("%02d",as.numeric(day))) %>% 
  mutate(ignore = as.Date(iconv(paste("01", month, "1800", sep=""), 
                  from='UTF-8', to='latin1'), "%d%b%Y"),
         month = as.numeric(lubridate::month(ignore)),
         month_name = month.abb[month]) %>% # utilize month.abb function, built into base R
  mutate(yr_mo_day = paste(year, month, day, sep="-")) %>% #combine all date columns and separate by -
  mutate(yr_mo = paste(year, month, sep="-")) %>%  #combine all date columns and separate by -
  #mutate(date = as.Date(yr_mo_day, format="%Y-%m-%d"))
  #mutate(date = with(fish, ymd(paste(year, month, day, sep= ' ')))) #tell R this is a date
  mutate(year_month = tsibble::yearmonth(yr_mo)) %>% #tell R this is a date
  select("year", "year_month", "value") #remove unnecessary variables


pd.to_datetime(fish[['year', 'month', 'day']])

```

### Look at the data day-by-day (original time series observations)
```{r}
fish_day <- ggplot(data=fish, aes(x=date, y=value)) +
  geom_line()

fish_day
```

Double check you did it right by looking at the first 1000 observations
```{r}
fish_trimmed <- tail(fish, n=500)

ggplot(data=fish_trimmed, aes(x=date, y=value)) +
  geom_line()
```

Look at the data month-by-month
```{r}
#fish_month <- ggplot(data=fish, aes(x=year_month, y=value)) +
#  geom_line()

#fish_month
```

Look at the data year-by-year
```{r}
fish_yr <- ggplot(data=fish, aes(x=year, y=value)) +
  geom_line()

fish_yr
```

### Make a season plot
```{r}
#Coerce dataframe to a tsibble
fish_ts <- as_tsibble(fish, index= yr_mo)

#plot tsibble fancy plots
fish_ts %>% autoplot(value)
fish_ts %>% gg_subseries(value)

#prep data frame for season plot
fish_summary <- fish %>% 
  group_by(yr_mo) %>%
  summarise(sums=sum(value)) %>% 
  mutate(year_month = tsibble::yearmonth(yr_mo)) %>% #tell R this is a date
  mutate(month = month(year_month, label = TRUE)) %>% 
  mutate(year = year(year_month))

#coerce data frame into a tsibble
fish_summary_ts <- as_tsibble(fish_summary, index= year_month) %>% 
  fill_gaps() #fill gaps because some dates didn't take measurements

#plot season plot
fish_summary_ts %>% gg_season(sums)

#make the same season plot but now in ggplot
ggplot(data=fish_summary, aes(x=month, y=sums, group=year)) +
  geom_line(aes(color=year))
```

Visualize annual steelhead passage counts
```{r}
#prep data frame for annual counts plot
fish_annual <- fish %>% 
  group_by(year) %>% 
  summarize(sums=sum(value))

#plot it
ggplot(data=fish_annual, aes(x=year, y=sums)) +
  geom_line()
```

